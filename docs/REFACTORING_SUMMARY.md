# 项目重构总结

## 完成的工作

### 1. 删除旧文件
- ✅ 删除 `collect/fetch_js.py`（功能已整合到 static_analyze.py）
- ✅ 删除 `collect/parse_js.py`（功能已整合到 static_analyze.py）

### 2. 优化静态分析模块
- ✅ 修复 `collect/static_analyze.py` 中所有正则表达式的空格问题
- ✅ 更新模块文档，明确职责和使用方法
- ✅ 验证工具可以正常运行并生成完整的分析结果

### 3. 更新文档
- ✅ 更新 `README.md` 架构图，反映新的三阶段流程
- ✅ 更新快速开始指南
- ✅ 更新 Pipeline Phases 说明
- ✅ 更新目录结构
- ✅ 更新使用示例
- ✅ 更新验收标准

### 4. 测试验证
- ✅ 创建 `tests/test_static_analyze.py` 单元测试
- ✅ 所有测试通过
- ✅ 实际运行静态分析工具，成功分析目标页面

## 新的项目流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         静态分析阶段（一次完成）                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  static_analyze.py ──────────────► static_analysis.json                 │
│  (合并 fetch + parse + detect)      (完整的静态分析结果)                 │
│                                                                         │
│  输出内容：                                                              │
│  • 加密库识别（CryptoJS, JSEncrypt...）                                  │
│  • 加密模式检测（AES, RSA, HMAC...）                                     │
│  • 函数名提取（sendDataAes, encryptData...）                             │
│  • API 端点发现（/encrypt/aes.php...）                                   │
│  • 安全弱点标记（硬编码密钥、弱算法...）                                   │
│  • 端点-函数-加密 三方映射                                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         动态采集阶段                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Playwright + Hook ──────────────► baseline_samples/                    │
│                                                                         │
│  • 根据静态分析发现的端点，针对性采集                                      │
│  • Hook 加密函数，捕获明文/密钥/密文                                      │
│  • 生成真实请求基线                                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         验证与测试阶段                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Handler 验证 ──► 参数变异 ──► 安全评估 ──► 报告生成                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 实际测试结果

使用 `http://encrypt-labs-main/easy.php` 进行测试：

### 静态分析结果
```bash
python collect/static_analyze.py --url http://encrypt-labs-main/easy.php
```

**发现：**
- ✅ 8个API端点
- ✅ 35个加密模式匹配
- ✅ 1258个函数定义
- ✅ 2个安全问题（弱DES算法 + 硬编码密钥）
- ✅ 6个端点-加密映射

**识别的端点：**
1. `/encrypt/aes.php` - AES加密
2. `/encrypt/aesserver.php` - AES加密（服务器密钥）
3. `/encrypt/rsa.php` - RSA加密
4. `/encrypt/aesrsa.php` - AES+RSA混合加密
5. `/encrypt/des.php` - DES加密
6. `/encrypt/signdata.php` - HMAC签名
7. `/encrypt/signdataserver.php` - 服务器端签名
8. `/encrypt/norepeater.php` - 防重放

**安全发现：**
- ⚠️ 使用了弱加密算法 DES
- ⚠️ 检测到硬编码密钥

## 下一步工作

### Phase 2: 动态采集
- [ ] 完善 `scripts/capture_baseline.py`
- [ ] 基于静态分析结果自动配置 Playwright
- [ ] 实现 Hook 机制捕获加密函数调用

### Phase 3: Handler 实现
- [ ] 根据静态分析结果创建 Handler 模板
- [ ] 实现 AES Handler
- [ ] 实现 RSA Handler
- [ ] 实现 HMAC Handler

### Phase 4: 验证与测试
- [ ] 对比 Handler 输出与基线样本
- [ ] 实现参数变异测试
- [ ] 生成安全评估报告

## 关键改进

1. **简化流程**：从原来的多步骤（fetch → parse → detect）简化为一步静态分析
2. **清晰职责**：静态分析只负责源码分析，不涉及动态执行
3. **完整输出**：一次运行生成完整的 JSON，包含所有静态分析信息
4. **易于扩展**：模块化设计，便于添加新的加密模式检测

## 注意事项

- `analysis/detect_crypto.py` 保留用于可选的高级分析和验证
- 基线样本由 Playwright 动态采集，与静态分析分离
- Handler 验证是独立阶段，基于静态分析和基线样本的对比

